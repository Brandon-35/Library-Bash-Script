#!/bin/bash

# ==============================================================
#  ğŸš€ GIT COMMIT MESSAGE HOOK (Conventional Commits)
#  ğŸ”¹ Check commit message before committing
#  ğŸ”¹ Prevent incorrect format commits, making Git log more readable & consistent
# ==============================================================

# âœ… Valid commit structure:
# type(scope): subject
# <body> (optional)
# <footer> (optional)
#
# ğŸ”¹ Where:
# - `type`  (Required): Type of commit (feat, fix, chore, ...)
# - `scope` (Optional): Scope of changes (auth, api, database, ...)
# - `subject` (Required): Brief description of the changes (written in imperative mood)
#
# ğŸ“Œ Example of a valid commit:
# feat(auth): implement JWT authentication
# fix(cart): fix checkout button not working
# docs(readme): update installation instructions

# ==============================================================
#  ğŸ”¹ List of commit types (Type) + Meaning ğŸ”¹
# ==============================================================

COMMIT_TYPES=(
    "feat: âœ¨ Add a new feature"
    "fix: ğŸ› Fix a bug"
    "docs: ğŸ“š Documentation changes"
    "style: ğŸ¨ Code style, formatting"
    "refactor: ğŸ”§ Refactoring code"
    "test: ğŸ§ª Adding tests"
    "chore: ğŸ”¨ Build tasks, dependencies"
    "build: ğŸ— Build system changes"
    "perf: âš¡ Performance improvements"
    "ci: ğŸ¤– CI configuration changes"
    "revert: âª Revert changes"
)

# ==============================================================
#  ğŸ”¹ Check commit message before committing ğŸ”¹
# ==============================================================

commit_msg_file="$1"

# Check if the commit is an automatic merge, skip format check
if grep -qE "^Merge branch" "$commit_msg_file"; then
    echo "ğŸ”„ Merge commit detected, skipping commit message validation."
    exit 0
fi

# Read commit message from file (the command git commit -m "..." will write here)
commit_msg=$(head -n1 "$commit_msg_file")

echo "ğŸ” Checking commit message: '$commit_msg'"

# Check if the commit is in the correct format
if ! echo "$commit_msg" | grep -Eq "^(feat|fix|docs|style|refactor|test|chore|build|perf|ci|revert)(\([a-zA-Z0-9/_-]+\))?: .+"; then
    echo -e "\nâŒ  ERROR: Commit message is not in the correct format!"
    echo -e "âœ…  Please use the format: type(scope): subject\n"
    
    echo "ğŸ”¹ Valid commit types:"
    for commit_type in "${COMMIT_TYPES[@]}"; do
        echo -e "  - $commit_type"
    done
    
    echo -e "\nğŸ“Œ Example of a correct commit:"
    echo "  feat(auth): implement JWT authentication"
    echo "  fix(cart): fix checkout button not working"
    echo "  docs(readme): update installation instructions"

    exit 1
fi

# If the commit is in the correct format, allow to proceed
exit 0
